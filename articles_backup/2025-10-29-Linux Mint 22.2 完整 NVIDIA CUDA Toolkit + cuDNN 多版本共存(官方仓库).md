---
title: "Linux Mint 22.2 完整 NVIDIA CUDA Toolkit + cuDNN 多版本共存(官方仓库)"
created_at: "2025-10-29 14:58:30"
updated_at: "2025-10-29 14:58:30"
issue_number: 55
labels: ['tips']
url: https://github.com/syaofox/syaofox.github.io/issues/55
---

# Linux Mint 22.2 完整 NVIDIA CUDA Toolkit + cuDNN 多版本共存(官方仓库)

# **Linux Mint 22.2 完整 NVIDIA CUDA Toolkit + cuDNN 多版本共存教程**  
**使用 NVIDIA 官方仓库 | 驱动使用 Mint 自带 580.95.05 | 完全锁定防覆盖 | X11 环境**

> **目标**：  
> - 驱动：**Mint 自带 `nvidia-driver-580`**（已安装）→ **永不被覆盖**  
> - CUDA：**官方仓库安装多个版本**（12.1、12.6 等）  
> - cuDNN：**官方仓库 `apt` 安装**（自动匹配路径）  
> - 多版本共存：**`environment-modules` 动态切换**  
> - 安全机制：`apt-mark hold` + `apt pinning` + **不安装 `cuda` 元包**

---

## **系统信息（请确认）**

```bash
# 显卡
01:00.0 VGA compatible controller: NVIDIA Corporation GA106 [GeForce RTX 3060 Lite Hash Rate] (rev a1)

# 当前驱动
NVIDIA-SMI 580.95.05   Driver Version: 580.95.05   CUDA Version: 12.6
```

---

## **第 1 步：锁定 Mint 自带驱动（终极防覆盖）**

```bash
# 1. 列出所有已安装的 nvidia 包
sudo dpkg -l | grep '^ii' | grep -E "nvidia|libnvidia" | awk '{print $2}' > /tmp/nvidia_lock.txt

# 2. 锁定它们
sudo apt-mark hold $(cat /tmp/nvidia_lock.txt)

# 3. 额外锁定常见驱动包
sudo apt-mark hold nvidia-driver-580 nvidia-utils-580 nvidia-settings libnvidia-gl-580

# 4. 验证锁定
apt-mark showhold | grep nvidia
```

> **效果**：即使添加 NVIDIA 官方仓库，`apt upgrade` 也**不会动驱动**。

---

## **第 2 步：添加 NVIDIA 官方 CUDA 仓库（Ubuntu 24.04）**

```bash
# 下载并安装 keyring（官方推荐）
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb

# 更新包索引
sudo apt update
```

> 仓库地址：`https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/`

---

## **第 3 步：安装多个 CUDA Toolkit（不带驱动）**

```bash
# 安装 CUDA 12.1
sudo apt install cuda-toolkit-12-1 -y

# 安装 CUDA 12.6
sudo apt install cuda-toolkit-12-6 -y

# 如需更多版本（任选）
# sudo apt install cuda-toolkit-12-2 cuda-toolkit-12-3 cuda-toolkit-12-4 cuda-toolkit-12-5 -y
```

> 安装路径：  
> - `/usr/local/cuda-12.1/`  
> - `/usr/local/cuda-12.6/`

---

## **第 4 步：从官方仓库安装 cuDNN（自动匹配路径）**

```bash
# 查看可用 cuDNN 包
apt search libcudnn | grep -E "libcudnn8|libcudnn9"

# 安装 cuDNN 8.9.7 for CUDA 12.1
sudo apt install libcudnn8=8.9.7.29-1+cuda12.1 -y

# 安装 cuDNN 8.9.7 for CUDA 12.6
sudo apt install libcudnn8=8.9.7.29-1+cuda12.6 -y

# 如需 cuDNN 9（实验性，需 CUDA 12.4+）
# sudo apt install libcudnn9=9.8.0.87-1+cuda12.6 -y
```

> **自动安装路径**：  
> - `/usr/local/cuda-12.1/lib/libcudnn*`  
> - `/usr/local/cuda-12.6/lib/libcudnn*`  
> - 自动创建软链接：`/usr/lib/x86_64-linux-gnu/libcudnn.so.8`

---

## **第 5 步：安装 `environment-modules`（多版本切换）**

```bash
sudo apt install environment-modules -y
source /etc/profile.d/modules.sh
```

---

## **第 6 步：创建 Modulefiles（自动切换环境）**

```bash
sudo mkdir -p /usr/share/modules/modulefiles/cuda
```

### **创建 `cuda/12.1` 模块**

```bash
sudo tee /usr/share/modules/modulefiles/cuda/12.1 > /dev/null << 'EOF'
#%Module1.0
proc ModulesHelp { } {
    puts stderr "CUDA 12.1 + cuDNN 8.9.7 - Driver 580.95.05"
}
module-whatis "CUDA 12.1 with cuDNN 8.9.7"

# 自动卸载其他版本
foreach ver {12.2 12.3 12.4 12.5 12.6} {
    if { [is-loaded cuda/$ver] } {
        module unload cuda/$ver
    }
}

setenv CUDA_HOME /usr/local/cuda-12.1
prepend-path PATH /usr/local/cuda-12.1/bin
prepend-path LD_LIBRARY_PATH /usr/local/cuda-12.1/lib
prepend-path LD_LIBRARY_PATH /usr/local/cuda-12.1/extras/CUPTI/lib
conflict cuda
EOF
```

### **创建 `cuda/12.6` 模块**

```bash
sudo cp /usr/share/modules/modulefiles/cuda/12.1 /usr/share/modules/modulefiles/cuda/12.6
sudo sed -i 's/12.1/12.6/g' /usr/share/modules/modulefiles/cuda/12.6
sudo sed -i 's/cuDNN 8.9.7/cuDNN 8.9.7/g' /usr/share/modules/modulefiles/cuda/12.6
```

> 如需更多版本，复制并修改 `12.X`

---

## **第 7 步：设置默认版本 + 持久化**

```bash
# 设置默认版本为 12.1
sudo tee /usr/share/modules/modulefiles/cuda/.version > /dev/null << 'EOF'
#%Module
set ModulesVersion "12.1"
EOF

# 每次登录自动加载默认 CUDA
echo "module load cuda" >> ~/.bashrc
```

---

## **第 8 步：APT Pinning（终极保险，防误装 `cuda` 元包）**

```bash
sudo tee /etc/apt/preferences.d/cuda-no-driver > /dev/null << 'EOF'
# 禁止安装 cuda 元包（会拉驱动）
Package: cuda
Pin: version *
Pin-Priority: -1

# 优先使用 Mint 驱动
Package: nvidia-driver-*
Pin: origin ""
Pin-Priority: 1001
EOF
```

> 即使运行 `sudo apt install cuda`，也会被 **优先级 -1 拒绝**

---

## **第 9 步：验证安装**

```bash
# 重新加载模块环境
source /etc/profile.d/modules.sh

# 查看可用模块
module avail

# 加载 12.1
module load cuda/12.1

# 验证 CUDA
nvcc --version
# 输出：Cuda compilation tools, release 12.1, ...

# 验证 cuDNN
ls /usr/local/cuda-12.1/lib/libcudnn*
# 输出：libcudnn.so.8  libcudnn.so.8.9.7  ...

# 验证驱动未变
nvidia-smi
# 输出：Driver Version: 580.95.05

# 测试 PyTorch（可选）
python3 -c "import torch; print('CUDA:', torch.cuda.is_available()); print('cuDNN:', torch.backends.cudnn.version())"
# 输出：CUDA: True, cuDNN: 89729
```

---

## **切换版本示例**

```bash
# 切换到 12.6
module switch cuda/12.1 cuda/12.6

# 验证
nvcc --version  # 12.6
ls /usr/local/cuda-12.6/lib/libcudnn*  # 有文件
```

---

## **升级 / 卸载**

```bash
# 升级 cuDNN（仓库更新后）
sudo apt update
sudo apt upgrade libcudnn8 -y

# 卸载 CUDA 12.1
sudo apt purge cuda-toolkit-12-1 libcudnn8=8.9.7.29-1+cuda12.1 -y

# 卸载所有 CUDA
sudo apt purge 'cuda-toolkit-*' 'libcudnn*' -y
sudo rm -rf /usr/local/cuda-*
sudo rm -rf /usr/share/modules/modulefiles/cuda

# 解锁驱动（未来需更新驱动时）
sudo apt-mark unhold $(apt-mark showhold | grep nvidia)
```

---

## **一键安装脚本（复制粘贴即可）**

```bash
#!/bin/bash
set -e

echo "=== Linux Mint 22.2 CUDA + cuDNN 多版本安装脚本 ==="

# 1. 锁定驱动
echo "锁定 Mint 自带驱动..."
sudo dpkg -l | grep '^ii' | grep -E "nvidia|libnvidia" | awk '{print $2}' | xargs sudo apt-mark hold
sudo apt-mark hold nvidia-driver-580 nvidia-utils-580 nvidia-settings libnvidia-gl-580

# 2. 添加官方仓库
echo "添加 NVIDIA 官方 CUDA 仓库..."
wget -qO- https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb | sudo dpkg -i -
sudo apt update

# 3. 安装 CUDA Toolkit
echo "安装 CUDA 12.1 和 12.6..."
sudo apt install -y cuda-toolkit-12-1 cuda-toolkit-12-6

# 4. 安装 cuDNN
echo "安装 cuDNN 8.9.7..."
sudo apt install -y \
    libcudnn8=8.9.7.29-1+cuda12.1 \
    libcudnn8=8.9.7.29-1+cuda12.6

# 5. 安装 modules
echo "安装 environment-modules..."
sudo apt install -y environment-modules
source /etc/profile.d/modules.sh

# 6. 创建 modulefiles
echo "创建 modulefiles..."
sudo mkdir -p /usr/share/modules/modulefiles/cuda

sudo tee /usr/share/modules/modulefiles/cuda/12.1 > /dev/null << 'EOF'
#%Module1.0
proc ModulesHelp { } { puts stderr "CUDA 12.1 + cuDNN 8.9.7" }
module-whatis "CUDA 12.1"
foreach ver {12.2 12.3 12.4 12.5 12.6} { if {[is-loaded cuda/$ver]} { module unload cuda/$ver } }
setenv CUDA_HOME /usr/local/cuda-12.1
prepend-path PATH /usr/local/cuda-12.1/bin
prepend-path LD_LIBRARY_PATH /usr/local/cuda-12.1/lib
prepend-path LD_LIBRARY_PATH /usr/local/cuda-12.1/extras/CUPTI/lib
conflict cuda
EOF

sudo cp /usr/share/modules/modulefiles/cuda/12.1 /usr/share/modules/modulefiles/cuda/12.6
sudo sed -i 's/12.1/12.6/g' /usr/share/modules/modulefiles/cuda/12.6

# 7. 设置默认 + 持久化
sudo tee /usr/share/modules/modulefiles/cuda/.version > /dev/null << 'EOF'
#%Module
set ModulesVersion "12.1"
EOF
echo "module load cuda" >> ~/.bashrc

# 8. APT Pinning
sudo tee /etc/apt/preferences.d/cuda-no-driver > /dev/null << 'EOF'
Package: cuda
Pin: version *
Pin-Priority: -1
Package: nvidia-driver-*
Pin: origin ""
Pin-Priority: 1001
EOF

echo "安装完成！"
echo "使用方法："
echo "  module avail          # 查看版本"
echo "  module load cuda/12.1 # 加载 12.1"
echo "  module switch cuda/12.1 cuda/12.6  # 切换"
```

**保存为 `install-cuda.sh`，然后：**

```bash
chmod +x install-cuda.sh
sudo ./install-cuda.sh
```

---

## **最终状态**

| 项目 | 状态 |
|------|------|
| 驱动 | `580.95.05` **锁定** |
| CUDA 仓库 | 官方 `cuda-keyring` |
| CUDA 版本 | `12.1`, `12.6` 共存 |
| cuDNN | `8.9.7` **apt 安装** |
| 切换方式 | `module load cuda/12.X` |
| 安全 | `hold` + `pin` + 无 `cuda` 元包 |

---

**完结。**  
你现在拥有 **最干净、最安全、最易维护** 的多版本 CUDA 环境，**驱动永不被覆盖**，**cuDNN 自动更新**。

如需添加 `12.2`、`12.3` 等版本，只需：

```bash
sudo apt install cuda-toolkit-12-2 libcudnn8=8.9.7.29-1+cuda12.2 -y
```

并复制 modulefile 即可。

