---
title: "KVM 和 QEMU"
created_at: "2025-10-24 02:34:55"
updated_at: "2025-10-27 07:08:23"
issue_number: 50
labels: ['tips']
url: https://github.com/syaofox/syaofox.github.io/issues/50
---

# KVM 和 QEMU

在 Linux Mint 上安装 KVM 和 QEMU 通常非常简单，因为 Mint 是基于 Ubuntu 的，可以使用 `apt` 包管理器。

**KVM (Kernel-based Virtual Machine)** 是 Linux 内核中的一个虚拟化模块，它将 Linux 内核转换为一个 Type-1（裸金属）Hypervisor。**QEMU (Quick Emulator)** 是一个通用且开源的机器模拟器和虚拟化器。在 KVM 环境中，QEMU 与 KVM 协同工作，提供硬件模拟和加速。

通常还会安装 **Virtual Machine Manager (virt-manager)**，它是一个用于管理 KVM/QEMU 虚拟机的图形界面工具，让操作更简单。

以下是安装步骤：

### 步骤 1: 检查 CPU 是否支持虚拟化

首先，确认您的 CPU 支持硬件虚拟化（Intel VT-x 或 AMD-V）。

打开终端并运行以下命令：

```bash
egrep -c '(vmx|svm)' /proc/cpuinfo
```

  * 如果输出是 **0**，则表示您的 CPU 不支持硬件虚拟化，或者在 BIOS/UEFI 中未启用。如果没有硬件虚拟化支持，您将无法使用 KVM 加速。
  * 如果输出是 **1 或更大**，则表示您的 CPU 支持虚拟化，您可以继续下一步。

如果 BIOS/UEFI 中未启用虚拟化功能，您需要重启电脑进入 BIOS/UEFI 设置中启用它（通常在 "Security" 或 "Virtualization" 选项下）。

### 步骤 2: 安装 KVM/QEMU 和相关工具

更新您的软件包列表，然后安装所需的软件包：

```bash
sudo apt update
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager
```

  * `qemu-kvm`: 核心 QEMU 虚拟化程序包。
  * `libvirt-daemon-system`: libvirt 服务，用于管理虚拟化平台。
  * `libvirt-clients`: 用于与 libvirt 守护进程通信的客户端程序。
  * `bridge-utils`: 用于设置网络桥接工具（如果您需要高级网络配置）。
  * `virt-manager`: 图形界面管理工具，强烈推荐。

### 步骤 3: 验证 KVM 安装

安装完成后，您可以检查 KVM 模块是否已加载：

```bash
kvm-ok
```

如果一切正常，您应该看到类似下面的输出：

```
INFO: /dev/kvm exists
KVM acceleration can be used
```

### 4\. 将用户添加到 `libvirt` 和 `kvm` 组

为了能够以非 root 用户身份管理虚拟机，您需要将您的用户账号添加到 `libvirt` 和 `kvm` 用户组。请将 `$USER` 替换为您的实际用户名，或者直接使用 `$USER`（在终端中 `$USER` 会自动解析为当前用户名）。

```bash
sudo usermod -aG libvirt $USER
sudo usermod -aG kvm $USER
```

**注意：** 您可能需要**注销并重新登录**（或者重启电脑）才能使新的用户组成员身份生效。

### 步骤 5: 启动和验证 libvirt 服务

`libvirtd` 服务应该在安装时自动启动，但您可以检查其状态并确保它正在运行：

```bash
sudo systemctl status libvirtd
```

如果它没有运行，您可以启动它：

```bash
sudo systemctl start libvirtd
```

### 步骤 6: 启动 Virtual Machine Manager

注销并重新登录后，您应该可以通过应用程序菜单搜索 **"Virtual Machine Manager"** 或在终端中输入 `virt-manager` 来启动它。

现在您可以使用 `virt-manager` 的图形界面来创建和管理您的 KVM/QEMU 虚拟机了。



### 创建一个 Windows 虚拟机。

请确保您已完成上一步骤中的**注销并重新登录**操作，以使您的用户帐户能访问 `libvirt` 服务。

### 准备工作

1.  **Windows 安装镜像 (ISO 文件):** 确保您已经下载了您想安装的 Windows 版本的 ISO 文件（例如 Windows 10 或 Windows 11）。
2.  **驱动程序（可选但推荐）:** 为了获得更好的性能，建议准备 **VirtIO 驱动程序** ISO。在 Windows 安装过程中，您可能需要加载这些驱动程序才能识别虚拟硬盘和网卡。
      * 您可以在 [[Fedora 的 KVM 页面](https://www.google.com/search?q=https://fedoraproject.org/wiki/Windows_Virtio_Drivers)](https://www.google.com/search?q=https://fedoraproject.org/wiki/Windows_Virtio_Drivers) 上找到最新的 VirtIO 驱动 ISO 文件（通常名为 `virtio-win.iso`）。

### 创建 Windows 虚拟机步骤 (使用 virt-manager)

#### 1\. 启动 Virtual Machine Manager

在 Linux Mint 的应用程序菜单中搜索并打开 **“Virtual Machine Manager”**（或在终端中运行 `virt-manager`）。

#### 2\. 开始创建新的虚拟机

1.  点击窗口左上角的 **“文件” (File)** -\> **“新建虚拟机” (New Virtual Machine)**。
2.  选择安装方式，通常选择 **“本地安装介质（ISO 镜像或 CD-ROM）” (Local install media (ISO image or CDROM))**，然后点击“前进”。

#### 3\. 选择安装介质

1.  在 **“使用 ISO 镜像” (Use ISO image)** 旁点击 **“浏览” (Browse)**。
2.  点击 **“浏览本地” (Browse Local)**，然后导航到并选择您下载的 **Windows ISO 文件**。
3.  **操作系统类型和版本：** `virt-manager` 通常会自动检测操作系统。如果未自动识别，请手动选择 **“通用 OS” (Generic OS)**，然后输入您要安装的 Windows 版本（例如：`Windows 10` 或 `Windows 11`）。
4.  点击“前进”。

#### 4\. 配置内存和 CPU

根据您的主机配置和 Windows 版本的最低要求进行分配：

  * **内存 (RAM)：** 推荐至少 **4096 MB (4 GB)**，Windows 11 建议更高。
  * **CPU 核数 (CPUs)：** 推荐分配 **2** 个或更多核心。

分配的资源不应超过您主机系统的一半，以确保主机系统正常运行。

点击“前进”。

#### 5\. 配置存储空间

1.  选择 **“为虚拟机创建磁盘镜像” (Create a disk image for the virtual machine)**。
2.  **自定义存储大小：** 输入您希望分配给 Windows 虚拟机的硬盘大小。Windows 10/11 推荐至少 **60 GB**。
3.  点击“前进”。

#### 6\. 最终配置

1.  **名称：** 为您的虚拟机命名（例如：`Windows-11-VM`）。
2.  **网络选择：** 保持默认设置，通常是 **“NAT”**（用户模式网络），这样您的虚拟机就能通过主机访问互联网。
3.  **（高级选项 - 推荐操作）：**
      * 在左侧勾选 **“在安装前自定义配置” (Customize configuration before install)**。这允许您在启动前调整硬件设置。
4.  点击 **“完成” (Finish)**。

#### 7\. 优化和启动虚拟机

在打开的硬件配置窗口中，您可以进行一些性能优化（这是因为您勾选了上一步的自定义配置）：

1.  **CPU:** 检查 **“复制主机 CPU 配置” (Copy host CPU configuration)** 是否已勾选，这通常能提供最佳性能。
2.  **SATA/IDE 设备（可选，用于加载 VirtIO 驱动）:**
      * 点击左下角的 **“添加硬件” (Add Hardware)**。
      * 选择 **“存储” (Storage)**。
      * **设备类型 (Device type):** 选择 **“CDROM 设备” (CDROM device)**。
      * 选择您的 **`virtio-win.iso`** 文件作为存储源。这将在虚拟机中添加一个包含驱动程序的虚拟光驱。
3.  **NIC (网卡):** 确保 **“设备模型” (Device model)** 设置为 **VirtIO**（如果它没有自动选择，通常在创建 Windows VM 时，默认会使用兼容性更好的 Intel 或 Realtek）。

完成配置后，点击左上角的 **“开始安装” (Begin Installation)** 按钮。

### 步骤 8: 在虚拟机中安装 Windows

虚拟机将启动，您会看到 Windows 安装界面。

**重点：在 Windows 安装过程中加载 VirtIO 驱动**

当 Windows 安装程序要求您选择安装位置时，它可能**找不到任何硬盘驱动器**。这是正常的，因为 KVM 虚拟机默认使用高性能的 **VirtIO** 驱动，而 Windows 安装镜像中没有这些驱动。

1.  在选择安装位置的界面，点击 **“加载驱动程序” (Load driver)**。
2.  点击 **“浏览” (Browse)**，然后找到您在步骤 7 中添加的 VirtIO CD-ROM 驱动器。
3.  浏览到对应您 Windows 版本的文件夹（例如：`vioscsi` 或 `viostor` 文件夹下的 `w10` 或 `w11` 目录，并选择您的 CPU 架构，通常是 `amd64`）。
4.  加载驱动程序后，您的虚拟硬盘就会出现在列表中，您可以选择它并继续 Windows 的安装过程。

### 与宿主机共享剪贴板

虽然主机端的通道已配置好，但要实现剪贴板共享，您还需要确保 Ubuntu 24.04 虚拟机内部安装并运行着相应的客户端软件，即 Spice Guest Agent。

```bash
sudo apt install spice-vdagent qemu-guest-agent
```
- spice-vdagent 是实现剪贴板共享和桌面分辨率自动调整的关键软件包。
- 虽然 spice-vdagent 处理剪贴板，但 qemu-guest-agent 允许 KVM 主机执行更高级的操作，如干净关机和获取 IP 地址。您的 KVM 配置中也有 Channel (qemu-ga) 对应此代理。


