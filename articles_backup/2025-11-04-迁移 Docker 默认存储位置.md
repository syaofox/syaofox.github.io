---
title: "迁移 Docker 默认存储位置"
created_at: "2025-11-04 09:13:38"
updated_at: "2025-11-04 09:13:38"
issue_number: 60
labels: ['tips']
url: https://github.com/syaofox/syaofox.github.io/issues/60
---

# 迁移 Docker 默认存储位置

Docker 默认将镜像、容器、卷等数据存储在 **`/var/lib/docker`** 目录下。如果你想**移动 Docker 的默认存储位置**（例如迁移到更大的磁盘或 SSD），可以通过以下几种方式实现：

---

## 方法一：修改 Docker Daemon 配置文件（推荐，适用于大多数系统）

### 1. 停止 Docker 服务
```bash
sudo systemctl stop docker
sudo systemctl stop docker.socket
```

### 2. 创建新存储目录
假设你想迁移到 `/mnt/docker-data`（请确保磁盘已挂载）：
```bash
sudo mkdir -p /mnt/docker-data
```

### 3. 复制原有数据（rsync 推荐，保留权限和符号链接）
```bash
sudo rsync -avz /var/lib/docker/ /mnt/docker-data/
```

> 注意：`-a` 保留权限，`-v` 显示进度，`-z` 压缩传输（可选）

### 4. 备份原目录（可选）
```bash
sudo mv /var/lib/docker /var/lib/docker.bak
```

### 5. 配置 Docker 使用新路径

#### 对于 **systemd 系统**（Ubuntu、CentOS 7+、Debian 等）

创建或编辑 systemd 配置文件：
```bash
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo nano /etc/systemd/system/docker.service.d/override.conf
```

写入以下内容：
```ini
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --data-root=/mnt/docker-data
```

> 注意：
> - 必须写 **两行 `ExecStart=`**，第一行清空默认启动项
> - `--data-root` 是关键参数，指定新存储路径
> - 保留 `-H fd://` 和 `--containerd` 参数

#### 对于 **非 systemd 系统**（老版本或 Docker Desktop 以外）

编辑 `/etc/docker/daemon.json`：
```bash
sudo mkdir -p /etc/docker
sudo nano /etc/docker/daemon.json
```

写入：
```json
{
  "data-root": "/mnt/docker-data"
}
```

---

### 6. 重载 systemd 并启动 Docker
```bash
sudo systemctl daemon-reload
sudo systemctl start docker
```

### 7. 验证是否生效
```bash
docker info | grep "Docker Root Dir"
```
输出应为：
```
Docker Root Dir: /mnt/docker-data
```

---

## 方法二：使用符号链接（软链接，简单但不推荐生产）

> 适用于临时或测试环境，**不推荐用于生产**（因挂载顺序问题可能导致启动失败）

```bash
sudo systemctl stop docker
sudo rsync -avz /var/lib/docker/ /mnt/docker-data/
sudo rm -rf /var/lib/docker
sudo ln -s /mnt/docker-data /var/lib/docker
sudo systemctl start docker
```

---

## 方法三：LVM / 磁盘分区挂载（高级）

如果你是全新安装或使用 LVM：

1. 创建新分区（如 `/dev/sdb1`）
2. 格式化并挂载到 `/var/lib/docker`
```bash
sudo mkfs.ext4 /dev/sdb1
sudo mount /dev/sdb1 /var/lib/docker
```
3. 添加到 `/etc/fstab` 实现开机自动挂载：
```bash
/dev/sdb1  /var/lib/docker  ext4  defaults  0  2
```

---

## 方法四：Docker Desktop（Windows/macOS）

### Windows (WSL2)
1. 打开 Docker Desktop → Settings → Resources → Advanced
2. 修改 **Disk image location**
3. Apply & Restart

### macOS
1. Docker Desktop → Settings → Resources → Advanced
2. 修改 **Disk image location**（通常在 `~/Library/Containers/com.docker.docker`）

---

## 常见问题排查

| 问题 | 解决方案 |
|------|----------|
| `docker: permission denied` | 确保新目录权限为 `root:root`，并检查 SELinux/AppArmor |
| `cannot open directory '/var/lib/docker': Permission denied` | 使用 `chown -R root:root /mnt/docker-data` |
| 启动失败，提示 `overlay2` 错误 | 确保新磁盘支持 `overlay2` 存储驱动（ext4/xfs） |
| 旧数据未迁移 | 确认 `rsync` 完整复制，尤其是 `overlay2`、`containers`、`images` 目录 |

---

## 验证迁移成功

```bash
# 查看存储路径
docker info --format '{{.DockerRootDir}}'

# 查看磁盘使用
df -h /mnt/docker-data

# 启动一个测试容器
docker run hello-world
```

---

## 总结

| 方法 | 推荐度 | 适用场景 |
|------|--------|----------|
| `--data-root` + systemd | 5 stars | 生产服务器（Ubuntu/CentOS） |
| `daemon.json` | 4 stars | 简单配置、非 systemd |
| 符号链接 | 2 stars | 临时测试 |
| 磁盘挂载 | 5 stars | 全新安装 + 大容量磁盘 |

> **推荐方案**：使用 `systemd override.conf` + `--data-root`（方法一）

---

迁移完成后，建议定期运行：
```bash
docker system prune -a
```
清理无用镜像和缓存，保持新存储路径整洁。

